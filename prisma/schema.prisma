generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////
// ENUMS
//////////////////////////////

enum UserRole {
  ADMIN
  ORG_OWNER
  MANAGER
  STAFF
  VENDOR
  VOLUNTEER
  CUSTOMER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum PaymentProvider {
  PAYME
  CLICK
  UZUM
  STRIPE
  CASH
}

enum PaymentStatus {
  INITIATED
  SUCCEEDED
  FAILED
  REFUNDED
}

enum ServiceType {
  CATERING
  STAFFING
  SECURITY
  DECOR
  SOUND
  PHOTO_VIDEO
  TRANSPORT
  OTHER
}

enum TeamMemberRole {
  ORGANIZER
  COORDINATOR
  CASHIER
  CHECKIN
  OTHER
}

//////////////////////////////
// BASE MODELS
//////////////////////////////

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  phone        String?  @unique
  passwordHash String?
  fullName     String?
  avatarUrl    String?
  role         UserRole @default(CUSTOMER)
  isActive     Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organizationsOwned Organization[]       @relation("OrgOwner")
  orgMemberships     OrganizationMember[]

  eventsCreated Event[]  @relation("EventCreator")
  orders        Order[]
  tickets       Ticket[]
  reviews       Review[]

  volunteerProfile VolunteerProfile?
  vendorProfile    VendorProfile?

  tasks Task[]

  eventTeamMembers EventTeamMember[]
}

model Organization {
  id          Int     @id @default(autoincrement())
  name        String
  slug        String  @unique
  description String?
  website     String?

  ownerId Int
  owner   User @relation("OrgOwner", fields: [ownerId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members  OrganizationMember[]
  events   Event[]
  invoices Invoice[]
}

model OrganizationMember {
  id             Int      @id @default(autoincrement())
  organizationId Int
  userId         Int
  role           UserRole @default(MANAGER)

  createdAt DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([userId])
}

//////////////////////////////
// EVENT CORE
//////////////////////////////

model Event {
  id             Int         @id @default(autoincrement())
  organizationId Int?
  title          String
  description    String?
  coverUrl       String?
  status         EventStatus @default(DRAFT)

  startsAt DateTime
  endsAt   DateTime
  timezone String   @default("Asia/Tashkent")

  capacity  Int?
  isPrivate Boolean @default(false)

  venueId Int?
  venue   Venue? @relation(fields: [venueId], references: [id], onDelete: SetNull)

  createdById Int
  createdBy   User @relation("EventCreator", fields: [createdById], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Relations
  ticketTypes     TicketType[]
  orders          Order[]
  tasks           Task[]
  bookings        VenueBooking[]
  teamMembers     EventTeamMember[]
  serviceRequests ServiceRequest[]
  reviews         Review[]

  @@index([organizationId])
  @@index([createdById])
  @@index([startsAt])
}

model Venue {
  id      Int      @id @default(autoincrement())
  name    String
  address String?
  city    String?
  lat     Decimal? @db.Decimal(9, 6)
  lng     Decimal? @db.Decimal(9, 6)

  capacity     Int?
  priceFrom    Int? // optional: minimal price
  contactPhone String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings VenueBooking[]
  events   Event[]

  @@index([city])
}

model VenueBooking {
  id      Int           @id @default(autoincrement())
  venueId Int
  eventId Int
  status  BookingStatus @default(PENDING)

  reservedFrom DateTime
  reservedTo   DateTime

  notes String?

  createdAt DateTime @default(now())

  venue Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([venueId, reservedFrom, reservedTo])
  @@index([eventId])
}

//////////////////////////////
// TICKETING & PAYMENTS
//////////////////////////////

model TicketType {
  id       Int    @id @default(autoincrement())
  eventId  Int
  name     String
  price    Int    @default(0) // in minimal currency unit (e.g. so'm)
  currency String @default("UZS")

  quantityTotal Int?
  quantitySold  Int  @default(0)

  salesStartAt DateTime?
  salesEndAt   DateTime?

  createdAt DateTime @default(now())

  event      Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets    Ticket[]
  orderItems OrderItem[]

  @@index([eventId])
}

model Ticket {
  id           Int     @id @default(autoincrement())
  ticketTypeId Int
  orderId      Int?

  ownerId Int? // attendee user
  owner   User? @relation(fields: [ownerId], references: [id], onDelete: SetNull)

  code        String    @unique // QR / unique code
  checkedInAt DateTime?

  createdAt DateTime @default(now())

  ticketType TicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  order      Order?     @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([ticketTypeId])
  @@index([ownerId])
}

model Order {
  id      Int         @id @default(autoincrement())
  eventId Int
  buyerId Int
  status  OrderStatus @default(PENDING)

  amountTotal Int
  currency    String @default("UZS")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  buyer User  @relation(fields: [buyerId], references: [id], onDelete: Restrict)

  items    OrderItem[]
  payments Payment[]
  tickets  Ticket[]

  @@index([eventId])
  @@index([buyerId])
}

model OrderItem {
  id           Int    @id @default(autoincrement())
  orderId      Int
  ticketTypeId Int
  quantity     Int    @default(1)
  unitPrice    Int

  order      Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  ticketType TicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Restrict)

  @@index([orderId])
}

model Payment {
  id       Int             @id @default(autoincrement())
  orderId  Int
  provider PaymentProvider
  status   PaymentStatus   @default(INITIATED)

  amount   Int
  currency String @default("UZS")

  providerRef  String? @unique
  errorCode    String?
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model Invoice {
  id             Int      @id @default(autoincrement())
  organizationId Int
  periodStart    DateTime
  periodEnd      DateTime
  amount         Int
  currency       String   @default("UZS")

  issuedAt DateTime  @default(now())
  paidAt   DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, periodStart, periodEnd])
}

//////////////////////////////
// TASKS / PLANNING
//////////////////////////////

model Task {
  id          Int        @id @default(autoincrement())
  eventId     Int
  title       String
  description String?
  status      TaskStatus @default(TODO)
  dueAt       DateTime?

  assigneeId Int?
  assignee   User?   @relation(fields: [assigneeId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([assigneeId])
  @@index([status])
}

model EventTeamMember {
  id      Int            @id @default(autoincrement())
  eventId Int
  userId  Int
  role    TeamMemberRole @default(ORGANIZER)

  createdAt DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
}

//////////////////////////////
// VENDORS / SERVICES (Catering, Staff, etc.)
//////////////////////////////

model VendorProfile {
  id          Int     @id @default(autoincrement())
  userId      Int  @unique
  displayName String
  bio         String?
  city        String?
  phone       String?
  website     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  services VendorService[]
  offers   ServiceOffer[]
}

model VendorService {
  id     Int   @id @default(autoincrement())
  vendorId  Int
  type      ServiceType
  title     String
  priceFrom Int?
  currency  String      @default("UZS")
  isActive  Boolean     @default(true)

  vendor VendorProfile @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([type])
}

model ServiceRequest {
  id     Int   @id @default(autoincrement())
  eventId  Int
  type     ServiceType
  details  String?
  budget   Int?
  currency String      @default("UZS")

  createdAt DateTime @default(now())

  event  Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  offers ServiceOffer[]

  @@index([eventId])
  @@index([type])
}

model ServiceOffer {
  id     Int   @id @default(autoincrement())
  requestId  Int
  vendorId   Int
  price      Int
  currency   String    @default("UZS")
  message    String?
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  request ServiceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  vendor  VendorProfile  @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([requestId, vendorId])
  @@index([vendorId])
}

//////////////////////////////
// VOLUNTEERS
//////////////////////////////

model VolunteerProfile {
  id     Int   @id @default(autoincrement())
  userId Int   @unique
  city   String?
  skills String[] // PostgreSQL supports text[]; Prisma maps String[]
  bio    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//////////////////////////////
// REVIEWS
//////////////////////////////

model Review {
  id       Int @id @default(autoincrement())
  eventId  Int
  authorId Int

  rating  Int // 1..5
  comment String?

  createdAt DateTime @default(now())

  event  Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  author User  @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@unique([eventId, authorId])
  @@index([eventId])
  @@index([authorId])
}
